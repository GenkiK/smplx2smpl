Bootstrap: docker
From: nvidia/cuda:11.8.0-cudnn8-devel-ubuntu22.04

%post
    export DEBIAN_FRONTEND=noninteractive
    export DEBCONF_NONINTERACTIVE_SEEN=true
    export PYTHONNOUSERSITE=1

    export TORCH_CUDA_ARCH_LIST="6.1;7.0;7.5;8.0;8.6"
    export PYENV_ROOT=/opt/pyenv
    export PATH="$PYENV_ROOT/shims:$PYENV_ROOT/bin:$PATH"
    export PYTHON_VERSION=3.10.10
    export EGL_DEVICE_ID=1

    rm -rf /var/lib/apt/lists/*
    apt-get -y update
    apt-get -y install vim gcc lv git wget curl ffmpeg locales zlib1g-dev \
    libbz2-dev libssl-dev libreadline-dev libjpeg-dev libboost-dev p7zip-full \
    build-essential libdb-dev libreadline-dev libffi-dev libgdbm-dev liblzma-dev \
    libncursesw5-dev libsqlite3-dev libssl-dev zlib1g-dev uuid-dev tk-dev parallel fuse-zip
    apt-get -y install libglfw3-dev libgles2-mesa-dev freeglut3-dev
    apt-get -y install libnvidia-gl-535-server ninja-build
    locale-gen ja_JP.UTF-8

    git clone https://github.com/pyenv/pyenv.git /opt/pyenv
    pyenv install $PYTHON_VERSION
    pyenv global $PYTHON_VERSION
    eval "$(pyenv init -)"

    python -m pip install --upgrade pip
    pip install torch==2.4.0 torchvision==0.19.0 --index-url https://download.pytorch.org/whl/cu118

    pip install setuptools wheel
    pip --no-cache-dir install numpy==1.26.4
    pip --no-cache-dir install git+https://github.com/mattloper/chumpy.git
    pip --no-cache-dir install torchgeometry==0.1.2
    pip --no-cache-dir install PyYAML==5.1.1
    pip --no-cache-dir install configargparse

    # install smplx
    mkdir /workspace
    cd /workspace
    git clone https://github.com/GenkiK/smplx.git
    cd smplx
    pip install -e .

    pip --no-cache-dir install pillow
    pip --no-cache-dir install opencv-python
    pip --no-cache-dir install tqdm
    pip --no-cache-dir install -e git+https://github.com/nghorbani/human_body_prior#egg=human_body_prior
    pip --no-cache-dir install pyrender==0.1.45
    pip --no-cache-dir install shapely
    pip --no-cache-dir install trimesh==4.4.4
    pip --no-cache-dir install omegaconf==2.3.0
    pip --no-cache-dir install loguru==0.7.2
    pip --no-cache-dir install matplotlib


%environment
    export PYENV_ROOT=/opt/pyenv
    export PATH="$PYENV_ROOT/shims:$PYENV_ROOT/bin:$PATH"
    export PYTHONNOUSERSITE=1
    export EGL_DEVICE_ID=1